import{n as b,s as g,aj as re,ai as se,E as ne,y as ie,al as de,aa as ce,am as pe,p as n,x as V,an as ve,a0 as _e,Q as fe,l as ee,D as me,m as ge,B as be}from"./index.f337fba3.js";import{Q as Fe}from"./QCircularProgress.a5385098.js";import{a as he,u as qe}from"./use-dark.1793b84e.js";import{u as ye,a as Ue,b as Se}from"./use-file.4eb8e7ad.js";import{h as ae}from"./format.3e32b8d9.js";function te(r){return(r*100).toFixed(2)+"%"}const we={...he,...ye,label:String,color:String,textColor:String,square:Boolean,flat:Boolean,bordered:Boolean,noThumbnails:Boolean,autoUpload:Boolean,hideUploadBtn:Boolean,disable:Boolean,readonly:Boolean},oe=[...Ue,"start","finish","added","removed"];function xe(r,m){const u=me(),{props:t,slots:d,emit:c,proxy:w}=u,{$q:x}=w,$=qe(t,x);function C(a,l,v){if(a.__status=l,l==="idle"){a.__uploaded=0,a.__progress=0,a.__sizeLabel=ae(a.size),a.__progressLabel="0.00%";return}if(l==="failed"){w.$forceUpdate();return}a.__uploaded=l==="uploaded"?a.size:v,a.__progress=l==="uploaded"?1:Math.min(.9999,a.__uploaded/a.size),a.__progressLabel=te(a.__progress),w.$forceUpdate()}const j=b(()=>t.disable!==!0&&t.readonly!==!0),Q=g(!1),P=g(null),z=g(null),e={files:g([]),queuedFiles:g([]),uploadedFiles:g([]),uploadedSize:g(0),updateFileStatus:C,isAlive:()=>re(u)===!1},{pickFiles:i,addFiles:h,onDragover:s,onDragleave:p,processFiles:I,getDndNode:A,maxFilesNumber:D,maxTotalSizeNumber:T}=Se({editable:j,dnd:Q,getFileInput:W,addFilesToQueue:X});Object.assign(e,r({props:t,slots:d,emit:c,helpers:e,exposeApi:a=>{Object.assign(e,a)}})),e.isBusy===void 0&&(e.isBusy=g(!1));const f=g(0),N=b(()=>f.value===0?0:e.uploadedSize.value/f.value),k=b(()=>te(N.value)),B=b(()=>ae(f.value)),U=b(()=>j.value===!0&&e.isUploading.value!==!0&&(t.multiple===!0||e.queuedFiles.value.length===0)&&(t.maxFiles===void 0||e.files.value.length<D.value)&&(t.maxTotalSize===void 0||f.value<T.value)),o=b(()=>j.value===!0&&e.isBusy.value!==!0&&e.isUploading.value!==!0&&e.queuedFiles.value.length!==0);se(ve,Y);const S=b(()=>"q-uploader column no-wrap"+($.value===!0?" q-uploader--dark q-dark":"")+(t.bordered===!0?" q-uploader--bordered":"")+(t.square===!0?" q-uploader--square no-border-radius":"")+(t.flat===!0?" q-uploader--flat no-shadow":"")+(t.disable===!0?" disabled q-uploader--disable":"")+(Q.value===!0?" q-uploader--dnd":"")),L=b(()=>"q-uploader__header"+(t.color!==void 0?` bg-${t.color}`:"")+(t.textColor!==void 0?` text-${t.textColor}`:""));ne(e.isUploading,(a,l)=>{l===!1&&a===!0?c("start"):l===!0&&a===!1&&c("finish")});function R(){t.disable===!1&&(e.abort(),e.uploadedSize.value=0,f.value=0,K(),e.files.value=[],e.queuedFiles.value=[],e.uploadedFiles.value=[])}function F(){t.disable===!1&&G(["uploaded"],()=>{e.uploadedFiles.value=[]})}function M(){G(["idle","failed"],({size:a})=>{f.value-=a,e.queuedFiles.value=[]})}function G(a,l){if(t.disable===!0)return;const v={files:[],size:0},q=e.files.value.filter(_=>a.indexOf(_.__status)===-1?!0:(v.size+=_.size,v.files.push(_),_.__img!==void 0&&window.URL.revokeObjectURL(_.__img.src),!1));v.files.length!==0&&(e.files.value=q,l(v),c("removed",v.files))}function H(a){t.disable||(a.__status==="uploaded"?e.uploadedFiles.value=e.uploadedFiles.value.filter(l=>l.__key!==a.__key):a.__status==="uploading"?a.__abort():f.value-=a.size,e.files.value=e.files.value.filter(l=>l.__key!==a.__key?!0:(l.__img!==void 0&&window.URL.revokeObjectURL(l.__img.src),!1)),e.queuedFiles.value=e.queuedFiles.value.filter(l=>l.__key!==a.__key),c("removed",[a]))}function K(){e.files.value.forEach(a=>{a.__img!==void 0&&window.URL.revokeObjectURL(a.__img.src)})}function W(){return z.value||P.value.getElementsByClassName("q-uploader__input")[0]}function X(a,l){const v=I(a,l,e.files.value,!0),q=W();q!=null&&(q.value=""),v!==void 0&&(v.forEach(_=>{if(e.updateFileStatus(_,"idle"),f.value+=_.size,t.noThumbnails!==!0&&_.type.toUpperCase().startsWith("IMAGE")){const Z=new Image;Z.src=window.URL.createObjectURL(_),_.__img=Z}}),e.files.value=e.files.value.concat(v),e.queuedFiles.value=e.queuedFiles.value.concat(v),c("added",v),t.autoUpload===!0&&e.upload())}function J(){o.value===!0&&e.upload()}function O(a,l,v){if(a===!0){const q={type:"a",key:l,icon:x.iconSet.uploader[l],flat:!0,dense:!0};let _;return l==="add"?(q.onClick=i,_=Y):q.onClick=v,n(ee,q,_)}}function Y(){return n("input",{ref:z,class:"q-uploader__input overflow-hidden absolute-full",tabindex:-1,type:"file",title:"",accept:t.accept,multiple:t.multiple===!0?"multiple":void 0,capture:t.capture,onMousedown:_e,onClick:i,onChange:X})}function ue(){return d.header!==void 0?d.header(E):[n("div",{class:"q-uploader__header-content column"},[n("div",{class:"flex flex-center no-wrap q-gutter-xs"},[O(e.queuedFiles.value.length!==0,"removeQueue",M),O(e.uploadedFiles.value.length!==0,"removeUploaded",F),e.isUploading.value===!0?n(V,{class:"q-uploader__spinner"}):null,n("div",{class:"col column justify-center"},[t.label!==void 0?n("div",{class:"q-uploader__title"},[t.label]):null,n("div",{class:"q-uploader__subtitle"},[B.value+" / "+k.value])]),O(U.value,"add"),O(t.hideUploadBtn===!1&&o.value===!0,"upload",e.upload),O(e.isUploading.value,"clear",e.abort)])])]}function le(){return d.list!==void 0?d.list(E):e.files.value.map(a=>n("div",{key:a.__key,class:"q-uploader__file relative-position"+(t.noThumbnails!==!0&&a.__img!==void 0?" q-uploader__file--img":"")+(a.__status==="failed"?" q-uploader__file--failed":a.__status==="uploaded"?" q-uploader__file--uploaded":""),style:t.noThumbnails!==!0&&a.__img!==void 0?{backgroundImage:'url("'+a.__img.src+'")'}:null},[n("div",{class:"q-uploader__file-header row flex-center no-wrap"},[a.__status==="failed"?n(fe,{class:"q-uploader__file-status",name:x.iconSet.type.negative,color:"negative"}):null,n("div",{class:"q-uploader__file-header-content col"},[n("div",{class:"q-uploader__title"},[a.name]),n("div",{class:"q-uploader__subtitle row items-center no-wrap"},[a.__sizeLabel+" / "+a.__progressLabel])]),a.__status==="uploading"?n(Fe,{value:a.__progress,min:0,max:1,indeterminate:a.__progress===0}):n(ee,{round:!0,dense:!0,flat:!0,icon:x.iconSet.uploader[a.__status==="uploaded"?"done":"clear"],onClick:()=>{H(a)}})])]))}ie(()=>{e.isUploading.value===!0&&e.abort(),e.files.value.length!==0&&K()});const E={};for(const a in e)de(e[a])===!0?ce(E,a,()=>e[a].value):E[a]=e[a];return Object.assign(E,{upload:J,reset:R,removeUploadedFiles:F,removeQueuedFiles:M,removeFile:H,pickFiles:i,addFiles:h}),pe(E,{canAddFiles:()=>U.value,canUpload:()=>o.value,uploadSizeLabel:()=>B.value,uploadProgressLabel:()=>k.value}),m({...e,upload:J,reset:R,removeUploadedFiles:F,removeQueuedFiles:M,removeFile:H,pickFiles:i,addFiles:h,canAddFiles:U,canUpload:o,uploadSizeLabel:B,uploadProgressLabel:k}),()=>{const a=[n("div",{class:L.value},ue()),n("div",{class:"q-uploader__list scroll"},le()),A("uploader")];e.isBusy.value===!0&&a.push(n("div",{class:"q-uploader__overlay absolute-full flex flex-center"},[n(V)]));const l={ref:P,class:S.value};return U.value===!0&&Object.assign(l,{onDragover:s,onDragleave:p}),n("div",l,a)}}const ze=()=>!0;function ke(r){const m={};return r.forEach(u=>{m[u]=ze}),m}const Be=ke(oe);var Le=({name:r,props:m,emits:u,injectPlugin:t})=>ge({name:r,props:{...we,...m},emits:be(u)===!0?{...Be,...u}:[...oe,...u],setup(d,{expose:c}){return xe(t,c)}});function y(r){return typeof r=="function"?r:()=>r}const Re={url:[Function,String],method:{type:[Function,String],default:"POST"},fieldName:{type:[Function,String],default:()=>r=>r.name},headers:[Function,Array],formFields:[Function,Array],withCredentials:[Function,Boolean],sendRaw:[Function,Boolean],batch:[Function,Boolean],factory:Function},Ee=["factoryFailed","uploaded","failed","uploading"];function Ce({props:r,emit:m,helpers:u}){const t=g([]),d=g([]),c=g(0),w=b(()=>({url:y(r.url),method:y(r.method),headers:y(r.headers),formFields:y(r.formFields),fieldName:y(r.fieldName),withCredentials:y(r.withCredentials),sendRaw:y(r.sendRaw),batch:y(r.batch)})),x=b(()=>c.value>0),$=b(()=>d.value.length!==0);let C;function j(){t.value.forEach(e=>{e.abort()}),d.value.length!==0&&(C=!0)}function Q(){const e=u.queuedFiles.value.slice(0);u.queuedFiles.value=[],w.value.batch(e)?P(e):e.forEach(i=>{P([i])})}function P(e){if(c.value++,typeof r.factory!="function"){z(e,{});return}const i=r.factory(e);if(!i)m("factoryFailed",new Error("QUploader: factory() does not return properly"),e),c.value--;else if(typeof i.catch=="function"&&typeof i.then=="function"){d.value.push(i);const h=s=>{u.isAlive()===!0&&(d.value=d.value.filter(p=>p!==i),d.value.length===0&&(C=!1),u.queuedFiles.value=u.queuedFiles.value.concat(e),e.forEach(p=>{u.updateFileStatus(p,"failed")}),m("factoryFailed",s,e),c.value--)};i.then(s=>{C===!0?h(new Error("Aborted")):u.isAlive()===!0&&(d.value=d.value.filter(p=>p!==i),z(e,s))}).catch(h)}else z(e,i||{})}function z(e,i){const h=new FormData,s=new XMLHttpRequest,p=(o,S)=>i[o]!==void 0?y(i[o])(S):w.value[o](S),I=p("url",e);if(!I){console.error("q-uploader: invalid or no URL specified"),c.value--;return}const A=p("formFields",e);A!==void 0&&A.forEach(o=>{h.append(o.name,o.value)});let D=0,T=0,f=0,N=0,k;s.upload.addEventListener("progress",o=>{if(k===!0)return;const S=Math.min(N,o.loaded);u.uploadedSize.value+=S-f,f=S;let L=f-T;for(let R=D;L>0&&R<e.length;R++){const F=e[R];if(L>F.size)L-=F.size,D++,T+=F.size,u.updateFileStatus(F,"uploading",F.size);else{u.updateFileStatus(F,"uploading",L);return}}},!1),s.onreadystatechange=()=>{s.readyState<4||(s.status&&s.status<400?(u.uploadedFiles.value=u.uploadedFiles.value.concat(e),e.forEach(o=>{u.updateFileStatus(o,"uploaded")}),m("uploaded",{files:e,xhr:s})):(k=!0,u.uploadedSize.value-=f,u.queuedFiles.value=u.queuedFiles.value.concat(e),e.forEach(o=>{u.updateFileStatus(o,"failed")}),m("failed",{files:e,xhr:s})),c.value--,t.value=t.value.filter(o=>o!==s))},s.open(p("method",e),I),p("withCredentials",e)===!0&&(s.withCredentials=!0);const B=p("headers",e);B!==void 0&&B.forEach(o=>{s.setRequestHeader(o.name,o.value)});const U=p("sendRaw",e);e.forEach(o=>{u.updateFileStatus(o,"uploading",0),U!==!0&&h.append(p("fieldName",o),o,o.name),o.xhr=s,o.__abort=()=>{s.abort()},N+=o.size}),m("uploading",{files:e,xhr:s}),t.value.push(s),U===!0?s.send(new Blob(e)):s.send(h)}return{isUploading:x,isBusy:$,abort:j,upload:Q}}var je={name:"QUploader",props:Re,emits:Ee,injectPlugin:Ce},De=Le(je);export{De as Q};
