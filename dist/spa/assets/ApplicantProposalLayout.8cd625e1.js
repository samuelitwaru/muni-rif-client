import{_ as T,J as D,aL as C,r as l,o as r,e as i,w as a,f as o,l as p,i as d,j as m,t as _,u as h,F as B,k as I,g as L,Q as y,h as q,R as F}from"./index.f08ad6ba.js";import{Q as H}from"./QInput.99fe7471.js";import{Q as N}from"./QChip.7371d580.js";import{Q as O}from"./QToolbarTitle.26de3cd0.js";import{Q as M,a as j,b as A}from"./QLayout.58c05e22.js";import{Q as E}from"./QHeader.4f69035b.js";import{Q as W}from"./QCard.7bf12d0a.js";import{Q as w}from"./QSeparator.576b1ac8.js";import{Q as z,a as G}from"./QItem.aa34c858.js";import{Q as U}from"./QList.27f29234.js";import{Q as R}from"./QDrawer.1b2ac171.js";import{P as x}from"./ProposalHeader.3dd41b2c.js";import{c as J}from"./index.5ce110aa.js";import"./use-key-composition.8f3e2ed8.js";import"./use-dark.26c7a6e7.js";import"./use-split-attrs.f128f906.js";import"./uid.083ad4e2.js";import"./use-form.b0f97b95.js";import"./scroll.d4994559.js";import"./use-prevent-scroll.7137a01c.js";import"./use-timeout.cff15f03.js";import"./TouchPan.a1fe11cf.js";import"./touch.3df10340.js";import"./format.2bc25e5f.js";import"./QMarkupTable.af8cf3f4.js";const K=D({components:{ProposalHeader:x},name:"ProposalLayout",data(){return{formData:{title:""},proposal:null,editMode:!1,leftDrawerOpen:!1,score:{},sections:[],isAttachmentsValid:!1,isTeamValid:!1,isBudgetValid:!1,validity:{}}},computed:{wordCounts(){let e={};for(let t=0;t<this.sections.length;t++){const n=this.sections[t];e[n.name]=this.countWordsInHtml(this.proposal[n.name]||"")}return e},isProposalValid(){var e=!0;for(let t in this.validity)if(this.validity.hasOwnProperty(t)){if(this.validity[t])continue;return!1}return e}},created(){C(this.$options.__file),this.getProposal(),this.$bus.on("proposal-updated",e=>{this.getProposal(!1)}),this.$bus.on("attachments-updated",e=>{setTimeout(()=>{console.log("attachments-updated",e),this.isAttachmentsValid=e},1e3)})},methods:{getProposal(e=!0){this.$utilsStore.setLoading(e),this.$api.get(`proposals/${this.$route.params.proposal_id}/`).then(t=>{this.proposal=t.data,this.formData.title=this.proposal.title,this.$proposalStore.setProposal(this.proposal),this.getSections(),this.getScore(),this.getTeam(),this.getBudget(),this.$utilsStore.setLoading(!1)})},getTeam(){this.$api.get(`teams/?proposal=${this.$route.params.proposal_id}`).then(e=>{e.data.length?this.isTeamValid=!0:this.isTeamValid=!1})},getBudget(){this.$api.get(`budgets/?proposal=${this.$route.params.proposal_id}`).then(e=>{e.data.length?this.isBudgetValid=!0:this.isBudgetValid=!1})},getScore(){var e;this.$api.get(`scores/?user=${((e=this.$authStore.currentUser)==null?void 0:e.id)||0}&proposal=${this.$route.params.proposal_id}`).then(t=>{t.data.length==1&&(this.score=t.data[0])})},editProposalTitle(){this.$api.patch(`/proposals/${this.$route.params.proposal_id}/`,this.formData).then(e=>{this.$proposalStore.setProposal(e.data),this.editMode=!1})},deleteFile(e){confirm("Delete this File?")&&this.$api.delete(`files/${e}/`).then(t=>{this.getProposalFiles()})},getSections(){this.$api.get("sections/").then(e=>{this.sections=e.data})},downloadProposal(){this.$api.get(`proposals/${this.$route.params.proposal_id}/pdf/download/`).then(e=>{e.status==200&&window.open(e.data.file_url,"_blank")})},openFile(e){window.open(e)},countWordsInHtml(e){return J.load(e)("body").text().split(/\s+/).length},validateSection(e){let t=!1;return e.name=="attachments"?(t=this.isAttachmentsValid,this.validity[e.name]=t,t):e.name=="summary_budget"?(t=this.isBudgetValid,this.validity[e.name]=t,t):e.name=="team"?(t=this.isTeamValid,this.validity[e.name]=t,t):(t=this.wordCounts[e.name]>=e.lower_limit&&this.wordCounts[e.name]<=e.word_limit,this.validity[e.name]=t,t)}}}),X={class:"flex justify-between items-center"},Y={class:"q-my-xs"},Z={class:"flex"},ee=["href"],te={class:"text-caption q-px-sm q-my-auto q-mr-sm"},oe={key:0,align:"center",class:"flex justify-center q-mb-lg q-gutter-sm"};function se(e,t,n,b,v,ae){const P=l("loading-component"),k=l("proposal-options"),c=l("router-link"),Q=l("ProposalHeader"),V=l("router-view"),S=l("submit-proposal");return e.$proposalStore.currentProposal?(r(),i(A,{key:0,view:"lHh Lpr lFf"},{default:a(()=>[o(P),o(E,{elevated:""},{default:a(()=>[o(M,{class:"bg-white text-dark"},{default:a(()=>{var s;return[o(p,{flat:"",dense:"",round:"",icon:"menu","aria-label":"Menu",onClick:t[0]||(t[0]=u=>e.leftDrawerOpen=!e.leftDrawerOpen)}),o(O,{class:"flex justify-between items-center"},{default:a(()=>{var u,f,g;return[d("div",X,[d("div",Y,[e.editMode&&((u=e.$proposalStore.currentProposal)==null?void 0:u.status)=="EDITING"?(r(),i(H,{key:0,style:{"min-width":"20rem"},onBlur:e.editProposalTitle,modelValue:e.formData.title,"onUpdate:modelValue":t[1]||(t[1]=$=>e.formData.title=$),type:"text",outlined:"",dense:""},null,8,["onBlur","modelValue"])):(r(),m("span",{key:1,style:{cursor:"pointer"},onClick:t[2]||(t[2]=$=>e.editMode=!0)},_((f=e.$proposalStore.currentProposal)==null?void 0:f.title),1))]),o(N,{color:"secondary",class:"text-white",size:"md",label:(g=e.$proposalStore.currentProposal)==null?void 0:g.status},null,8,["label"])])]}),_:1}),d("div",Z,[((s=e.$proposalStore.currentProposal)==null?void 0:s.status)!="EDITING"?(r(),i(p,{key:0,color:"primary",icon:"download",dense:"",label:"download",onClick:e.downloadProposal},null,8,["onClick"])):h("",!0),o(k)])]}),_:1})]),_:1}),o(R,{modelValue:e.leftDrawerOpen,"onUpdate:modelValue":t[3]||(t[3]=s=>e.leftDrawerOpen=s),class:"bg-grey-2","show-if-above":"",bordered:"",width:220},{default:a(()=>[o(W,{flat:"",class:"q-py-sm"},{default:a(()=>[o(c,{to:"/applicant/proposals"},{default:a(()=>[o(p,{class:"q-mx-sm",block:"",color:"primary",flat:"",icon:"arrow_back",label:"My Proposals"})]),_:1})]),_:1}),o(w),o(U,null,{default:a(()=>[(r(!0),m(B,null,I(e.sections,s=>(r(),m("a",{key:s.id,href:`/applicant/proposals/${e.$route.params.proposal_id}${s.ref}`},[L((r(),i(z,{clickable:""},{default:a(()=>[d("div",te,[e.validateSection(s)?(r(),i(y,{key:0,size:"sm",color:"green",name:"check_circle_outline"})):(r(),i(y,{key:1,size:"sm",color:"red",name:"dangerous"}))]),o(G,null,{default:a(()=>[q(_(s.title),1)]),_:2},1024)]),_:2},1024)),[[F]]),o(w)],8,ee))),128))]),_:1})]),_:1},8,["modelValue"]),o(j,null,{default:a(()=>{var s;return[o(Q),o(V),((s=e.$proposalStore.currentProposal)==null?void 0:s.status)=="EDITING"?(r(),m("div",oe,[o(c,{class:"q-mx-sm",to:"/applicant/proposals"},{default:a(()=>[o(p,{color:"secondary",outline:"",icon:"check",label:"save and continue later"})]),_:1}),o(S,{disabled:!e.isProposalValid,proposal:e.$proposalStore.currentProposal},null,8,["disabled","proposal"])])):h("",!0)]}),_:1})]),_:1})):h("",!0)}var Ce=T(K,[["render",se]]);export{Ce as default};
